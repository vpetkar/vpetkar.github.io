<!DOCTYPE html><html lang="en-us"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><title>Promises in AngularJS | keys to the internet</title><meta name="description" content="Waiting for x before you do y, and all the beauties of async programming in AngularJS"><meta name="generator" content="keys to the internet"><meta name="author" content="Ved Petkar"><meta name="keywords" content="ved petkar, development, angular, ved, petkar, startups, san francisco, javascript, android, mobile, ios, swift, java"><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1,user-scalable=0"><meta name="google-site-verification" content="PIk4VO7xsss6hgn2zClh14MPp84KcjmkJvVfrtbJcws"><link rel="stylesheet" type="text/css" href="/styles/screen.css"><link rel="apple-touch-icon" sizes="57x57" href="/images/apple-touch-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/images/apple-touch-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/images/apple-touch-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/images/apple-touch-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/images/apple-touch-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/images/apple-touch-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/images/apple-touch-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/images/apple-touch-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-180x180.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/images/favicon-96x96.png"><link rel="icon" type="image/png" sizes="160x160" href="/images/favicon-160x160.png"><link rel="icon" type="image/png" sizes="192x192" href="/images/favicon-192x192.png"><meta name="msapplication-TileColor" content="#121315"><meta name="msapplication-TileImage" content="/images/mstile-144x144.png"><!-- Meta tags for posts--><meta name="description"><meta name="keywords"></head><body itemscope itemtype="https://schema.org/WebPage"><header itemscope itemtype="https://schema.org/WPHeader"><h1><a href="/" alt="keys to the internet" title="keys to the internet" itemprop="headline">keys to the internet</a></h1><p itemprop="description">along with mobile, servers, and peanut butter</p><p itemprop="author" class="author-tagline">Written with ♥ Ved Petkar</p><nav itemscope itemtype="https://schema.org/SiteNavigationElement"><ul><li itemprop="name"><a href="/tags" alt="Topics" title="Topics" itemprop="url">Topics</a></li><li itemprop="name"><a href="/about" alt="About" title="About" itemprop="url">About</a></li></ul></nav><div class="space"></div></header><main itemscope itemtype="https://schema.org/Blog"><article class="full"><h1 itemprop="headline">Promises in AngularJS</h1><span class="post-meta">Last updated<time itemprop="dateModified" datetime="2016-02-22T08:00:00.000Z"> Tuesday, March 1st 2016</time></span><p>Language: JavaScript<br>Stack: AngularJS, REST APIs</p>
<p>You’re building an AngularJS app that talks to an API, and nearly everything is done through <code>$http</code> or <code>$resource</code> calls. Get ready for async hell if you don’t foresee your data-loading order. This post is about how to make your app work reliably, using a the great <code>$q</code> module in Angular 1.x.</p>
<h2 id="Concept"><a href="#Concept" class="headerlink" title="Concept"></a>Concept</h2><p>Async programming and what it is is generally beyond the scope of this article, however the general jist is that if one part of your program/app depends on another function running first, there needs to be a process to force it to do that in a specific order.</p>
<h2 id="Use_cases"><a href="#Use_cases" class="headerlink" title="Use cases"></a>Use cases</h2><ul>
<li>Multiple API calls that depend on the result of the previous</li>
<li>Loading screens</li>
<li>User login/storage</li>
<li>Logic that depends on results of a web API</li>
</ul>
<p>Consider this example, you want to log in a user and then make another API call to the server with the User ID to get their information. However, you can’t make the 2nd query without having a reliable result from the first. This is where <code>$q</code> and async programming come into play. This will force one aspect of the application to run before the other.</p>
<h2 id="Promises_for_providers"><a href="#Promises_for_providers" class="headerlink" title="Promises for providers"></a>Promises for providers</h2><p>Generally speaking, you should be accessing/storing your “classes” (for OOP folks) inside AngularJS providers.</p>
<p>In the case of providers, you simply instantiate the provide and within provide a <code>$q</code> object that is subsequently used when accessing that Provider throughout the application.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">angular.module(<span class="string">'app'</span>)</span><br><span class="line">.factory(<span class="string">'UserProvider'</span>, [<span class="string">'$http'</span>, <span class="string">'$q'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">$http, $q</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    getUser: <span class="function"><span class="keyword">function</span>(<span class="params">user_email</span>) </span>&#123;</span><br><span class="line">      <span class="comment">// Tell Angular that this uses $q</span></span><br><span class="line">      <span class="keyword">var</span> deferred = $q.defer();</span><br><span class="line">      $http(&#123;</span><br><span class="line">        method: <span class="string">'GET'</span>,</span><br><span class="line">        url: <span class="string">'https://api.com/user/'</span> + user_email</span><br><span class="line">      &#125;).then(<span class="function"><span class="keyword">function</span> <span class="title">success</span>(<span class="params">response</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Validation goes here</span></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Store the object for future use if persistent</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Resolve the deferred object with the data that is received</span></span><br><span class="line">        deferred.resolve(response.data)</span><br><span class="line">      &#125;, <span class="function"><span class="keyword">function</span> <span class="title">error</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">        <span class="comment">//<span class="doctag">TODO:</span> Error handling goes here</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Resolve the deferred object with an error</span></span><br><span class="line">        deferred.reject(<span class="string">"API error"</span>)</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="comment">// Return a promise as opposed to the actual object</span></span><br><span class="line">      <span class="keyword">return</span> deferred.promise;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;]);</span><br></pre></td></tr></table></figure>
<p>After setting up your factory to return <code>deferred.promise</code> instead of your object directly, you are now ready to create dependent code wherever you use this factory. Here is a smaple controller that handles the deferred.promise object that is returned.</p>
<h3 id="Loading_screen"><a href="#Loading_screen" class="headerlink" title="Loading screen"></a>Loading screen</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">angular.module(<span class="string">'app'</span>)</span><br><span class="line">.controller(<span class="string">'ProfileCtrl'</span>, [<span class="string">'$scope'</span>, <span class="string">'UserProvider'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">$scope, UserProvider</span>)</span>&#123;</span><br><span class="line">  $scope.loading = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  UserProvider.getUser(<span class="string">"elonmusk@gmail.com"</span>).then(<span class="function"><span class="keyword">function</span>(<span class="params">userRecord</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Do whatever else you want with the record, knowing that it is returned</span></span><br><span class="line">    $scope.userRecord = userRecord;</span><br><span class="line">    $scope.loading = <span class="literal">false</span>;</span><br><span class="line">  &#125;, <span class="function"><span class="keyword">function</span>(<span class="params">error</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//<span class="doctag">TODO:</span> Handle a potential error</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;]);</span><br></pre></td></tr></table></figure>
<p>The above example simply deals with a <em>loading</em> page within an app. In the sense that the loading indicator is dismissed after the user record is retrieved via the API but not before.</p>
<h3 id="Subsequent_requests"><a href="#Subsequent_requests" class="headerlink" title="Subsequent requests"></a>Subsequent requests</h3><p>Sometimes you want to make subsequent requests based on data from previous requests, in this case you can nest your queries even further. In the following example, the user record is first retrieved and a request is made again to get the user’s posts. Notice how the loading dismissal is moved to after successful completion of the 2nd query.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">angular.module(<span class="string">'app'</span>)</span><br><span class="line">.controller(<span class="string">'ProfileCtrl'</span>,</span><br><span class="line">[<span class="string">'$scope'</span>, <span class="string">'UserProvider'</span>, <span class="string">'PostsProvider'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">$scope, UserProvider, PostsProvider</span>)</span>&#123;</span><br><span class="line">  $scope.loading = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  UserProvider.getUser(<span class="string">"elonmusk@gmail.com"</span>).then(<span class="function"><span class="keyword">function</span>(<span class="params">userRecord</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Do whatever else you want with the record, knowing that it is returned</span></span><br><span class="line">    $scope.userRecord = userRecord;</span><br><span class="line">    PostsProvider.getUserPosts(userRecord.user_id).then(<span class="function"><span class="keyword">function</span>(<span class="params">userPosts</span>) </span>&#123;</span><br><span class="line">      $scope.userPosts = userPosts;</span><br><span class="line">      $scope.loading = <span class="literal">false</span>;</span><br><span class="line">    &#125;, <span class="function"><span class="keyword">function</span>(<span class="params">error</span>) </span>&#123;</span><br><span class="line">      <span class="comment">//<span class="doctag">TODO:</span> Handle the potential error</span></span><br><span class="line">    &#125;);</span><br><span class="line">    $scope.loading = <span class="literal">false</span>;</span><br><span class="line">  &#125;, <span class="function"><span class="keyword">function</span>(<span class="params">error</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//<span class="doctag">TODO:</span> Handle a potential error</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;]);</span><br></pre></td></tr></table></figure>
<p>Note: It is assumed that the PostsProvider also implements the <code>$q</code> functionality as described above.</p>
<h3 id="Promises_for__24resource"><a href="#Promises_for__24resource" class="headerlink" title="Promises for $resource"></a>Promises for $resource</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">angular.module(<span class="string">'app'</span>)</span><br><span class="line">.factory(<span class="string">'CommentsProvider'</span>, [<span class="string">'$resource'</span>, (<span class="function"><span class="keyword">function</span>(<span class="params">$resource</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> $resource(<span class="string">'https://api.com/post/:postId/comments'</span>, &#123;postId: <span class="string">'@postId'</span>&#125;);</span><br><span class="line">&#125;]);</span><br></pre></td></tr></table></figure>
<p>Luckily, <em>the <code>$resource</code> system already has a built in promise system.</em> Therefore, there is no need to implement the <code>$q</code> functionality manually. The built in functionality of the <code>$resource</code> module can be accessed as shown:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CommentsProvider.query(&#123;postId: <span class="string">"12345"</span>&#125;).$promise.then(<span class="function"><span class="keyword">function</span>(<span class="params">comments</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// do something with 'comments'</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>That’s it! Hopefully</p>
</article></main><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
e=o.createElement(i);r=o.getElementsByTagName(i)[0];
e.src='//www.google-analytics.com/analytics.js';
r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
ga('create','UA-51865808-3');ga('send','pageview');</script></body></html>